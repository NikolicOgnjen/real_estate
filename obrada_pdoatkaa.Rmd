---
title: "4_zida_obrada"
output: html_document
date: "2025-10-10"
---

```{r setup, include=FALSE}
# Učitavanje potrebnih biblioteka
# tidyverse - za sveopštu manipulaciju podacima (dplyr, ggplot2, itd.)
# RSQLite - drajver za povezivanje sa SQLite bazama
# DBI - standardni interfejs za komunikaciju sa bazama
library(tidyverse)
library(RSQLite)
library(DBI)

# --- 1. Definisanje putanja do fajlova ---

# Osnovna putanja do projekta
# NAPOMENA: R preferira forward slashes (/) umesto backslashes (\)
base_path <- "C:/Users/Ognjen/Desktop/trziste_nekretnine"

# Imena fajlova baza podataka
db_name_4zida <- "nekretnine_4zida.db"
db_name_oglasi <- "oglasi.rs_data.db"
db_name_nekretnine_rs <- "nekretnine.rs_data.db" # NOVO

# Kompletne putanje do fajlova
db_path_4zida <- file.path(base_path, db_name_4zida)
db_path_oglasi <- file.path(base_path, db_name_oglasi)
db_path_nekretnine_rs <- file.path(base_path, db_name_nekretnine_rs) # NOVO


# --- 2. Učitavanje baze "4zida" ---

# Povezivanje sa bazom
con_4zida <- dbConnect(RSQLite::SQLite(), db_path_4zida)

# Učitavanje cele tabele "nekretnine" u data frame
df_4zida <- dbReadTable(con_4zida, "nekretnine")

# Zatvaranje konekcije - OBAVEZNO!
dbDisconnect(con_4zida)


# --- 3. Učitavanje baze "oglasi.rs" ---

# Povezivanje sa bazom
con_oglasi <- dbConnect(RSQLite::SQLite(), db_path_oglasi)

# Učitavanje cele tabele "oglasi" u data frame
df_oglasi <- dbReadTable(con_oglasi, "oglasi")

# Zatvaranje konekcije
dbDisconnect(con_oglasi)


# --- 4. Učitavanje baze "nekretnine.rs" --- NOVO

# Povezivanje sa bazom
con_nekretnine_rs <- dbConnect(RSQLite::SQLite(), db_path_nekretnine_rs)

# Učitavanje cele tabele "nekretnine" u data frame
# NAPOMENA: Pretpostavljamo da se tabela zove 'nekretnine'.
# Ako se zove drugačije, promenite ime ovde.
df_nekretnine_rs <- dbReadTable(con_nekretnine_rs, "oglasi")

# Zatvaranje konekcije
dbDisconnect(con_nekretnine_rs)


# --- 5. Provera i prikaz učitanih podataka ---

cat("--- Podaci sa 4zida.rs ---\n")
cat(paste("Učitano:", nrow(df_4zida), "redova i", ncol(df_4zida), "kolona.\n\n"))
glimpse(df_4zida) # glimpse() je najbolji način za brzi pregled strukture

cat("\n\n--- Podaci sa oglasi.rs ---\n")
cat(paste("Učitano:", nrow(df_oglasi), "redova i", ncol(df_oglasi), "kolona.\n\n"))
glimpse(df_oglasi)

# NOVO
cat("\n\n--- Podaci sa nekretnine.rs ---\n")
cat(paste("Učitano:", nrow(df_nekretnine_rs), "redova i", ncol(df_nekretnine_rs), "kolona.\n\n"))
glimpse(df_nekretnine_rs)

# Prikaz prvih 6 redova iz poslednje baze radi detaljnijeg uvida
cat("\n\n--- Prvih 6 oglasa sa nekretnine.rs ---\n")
head(df_nekretnine_rs)


```

```{r data wrangling}

# --- 1. Sređivanje df_oglasi ---
df_oglasi_clean <- df_oglasi %>%
  mutate(
    # Uklanjamo tačke kao separator hiljada, menjamo zarez u tačku za decimale,
    # uklanjamo " EUR" i konvertujemo u numerički format.
    # suppressWarnings se koristi jer će NA vrednosti (ako postoje) izazvati upozorenje.
    Cena = suppressWarnings(as.numeric(gsub(" EUR", "", gsub(",", ".", gsub("\\.", "", Cena))))),
    
    # Uklanjamo "m2" i konvertujemo u numerički format.
    Kvadratura = suppressWarnings(as.numeric(gsub("m2", "", Kvadratura))),
    
    # Konvertujemo datum iz teksta u R-ov Date format.
    Datum_preuzimanja = as.Date(Datum_preuzimanja),
    
    # Rešavamo problem gde je u koloni "Grad" ponekad pisalo "Prodaja stanova"
    Grad = if_else(Grad == "Prodaja stanova", NA_character_, Grad),
    
    # Dodajemo kolonu sa izvorom podataka.
    Izvor = "oglasi.rs"
  ) %>%
  # Biramo samo relevantne kolone i dajemo im standardna imena
  select(
    Cena, Kvadratura, Grad, Lokacija, Link, Datum_preuzimanja, Izvor
  )

# --- 2. Sređivanje df_nekretnine_rs ---
df_nekretnine_rs_clean <- df_nekretnine_rs %>%
  mutate(
    # Uklanjamo razmake i simbol "€", pa konvertujemo u broj.
    Cena = suppressWarnings(as.numeric(gsub("€", "", gsub(" ", "", Cena)))),
    
    # Uklanjamo razmak i "m²". Slučajevi "---" će postati NA, što je ispravno.
    Kvadratura = suppressWarnings(as.numeric(gsub(" m²", "", Kvadratura, fixed = TRUE))),
    
    # Konvertujemo datum
    Datum_preuzimanja = as.Date(Datum_preuzimanja),
    
    # Dodajemo izvor
    Izvor = "nekretnine.rs"
  ) %>%
  # NAJVAŽNIJI KORAK: Razdvajamo lokaciju na Deo grada, Grad i Državu
  separate(Lokacija, into = c("Lokacija", "Grad", "Drzava"), sep = ", ", remove = TRUE, fill = "left") %>%
  # Biramo i preimenujemo kolone da odgovaraju standardu
  select(
    Cena, Kvadratura, Grad, Lokacija, Link = URL, Datum_preuzimanja, Izvor
  )

# --- 3. Sređivanje df_4zida ---
df_4zida_clean <- df_4zida %>%
  mutate(
    # Cena i m2 su već numerički, što je odlično. Samo ih preimenujemo.
    # Kreiramo pun URL
    Link = paste0("https://www.4zida.rs", url_path),
    
    # Uzimamo samo datum iz 'scraped_at' kolone
    Datum_preuzimanja = as.Date(scraped_at),
    
    # Dodajemo izvor
    Izvor = "4zida"
  ) %>%
  # Biramo i preimenujemo kolone da odgovaraju standardu
  select(
    Cena = price,
    Kvadratura = m2,
    Grad = city,
    Lokacija = neighborhood,
    Link,
    Datum_preuzimanja,
    Izvor
  )

# --- 4. Provera rezultata ---

cat("--- Očišćeni podaci sa oglasi.rs ---\n")
glimpse(df_oglasi_clean)

cat("\n\n--- Očišćeni podaci sa nekretnine.rs ---\n")
glimpse(df_nekretnine_rs_clean)

cat("\n\n--- Očišćeni podaci sa 4zida.rs ---\n")
glimpse(df_4zida_clean)

# Prikaz prvih nekoliko redova jednog od sređenih setova podataka
cat("\n\n--- Primer sređenih podataka (4zida.rs) ---\n")
head(df_4zida_clean)



```


